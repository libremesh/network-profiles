#!/bin/sh

pushgateway_host=$(uci get lime-autogen.pushgateway.host)
pushgateway_user=$(uci get lime-autogen.pushgateway.user)
pushgateway_password=$(uci get lime-autogen.pushgateway.password)
metrics_file=/tmp/prometheus-metrics
domain=$(uci get lime-autogen.system.domain)
lan_ipv4=$(uci get network.lan.ipaddr)
wan_ipv4=$(ip -o route get to 4.2.2.2 | sed -n 's|.*src \([0-9.]\+\).*|\1|p')
host=$(uci get system.@system[0].hostname)
token="$(echo -n "$pushgateway_user:$pushgateway_password" | base64)"

prometheus-node-exporter-lua > "$metrics_file"
wget -qO /dev/null \
--post-file "$metrics_file" \
--header="Authorization: Basic $token" \
https://${pushgateway_host}/metrics\
/job/remote_nodes\
/domain/${domain}\
/instance/${lan_ipv4}\
/port/9090\
/host/${host}\
$( [ $wan_ipv4 != $lan_ipv4 ] && echo "/wan/$wan_ipv4" )

rm "$metrics_file"
